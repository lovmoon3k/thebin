SELECT H1.*
,(select to_char(LISTAGG(muc.CONVERSION_RATE,', ') WITHIN GROUP (ORDER BY muc.CONVERSION_RATE)) 
                from mtl_uom_conversions muc
               where muc.UNIT_OF_MEASURE = rt.UNIT_MEAS_LOOKUP_CODE) dulicate

,rt.UNIT_MEAS_LOOKUP_CODE duplicate
,rt.CURRENCY_CODE Mata_Uang
,rt.CURRENCY_CONVERSION_RATE Kurs
,MLN.KODE
 FROM
(
select MSIB.INVENTORY_ITEM_ID, MSIB.SEGMENT1, MSIB.DESCRIPTION, msib.PRIMARY_UOM_CODE SATUAN, msib.PRIMARY_UNIT_OF_MEASURE SATUAN1, mtln1.LOT_NUMBER, -1*sum(mtln1.PRIMARY_QUANTITY) QTY, MCB.SEGMENT1 KATEGORY
from mtl_material_transactions mmt1
,mtl_transaction_lot_numbers mtln1
,mtl_transaction_types mtt1
,MTL_SYSTEM_ITEMS_B MSIB
,MTL_ITEM_CATEGORIES MIC
,MTL_CATEGORIES_B MCB

WHERE mmt1.TRANSACTION_ID = mtln1.TRANSACTION_ID
and mmt1.TRANSACTION_TYPE_ID = mtt1.TRANSACTION_TYPE_ID
and mtln1.ORGANIZATION_ID = MSIB.ORGANIZATION_ID
and mtln1.INVENTORY_ITEM_ID = MSIB.INVENTORY_ITEM_ID
AND TRUNC(mtln1.TRANSACTION_DATE)
BETWEEN TO_DATE('01-'||:P_MONTH_FROM, 'DD-MON-RR')
AND LAST_DAY(TO_DATE('01-'||:P_MONTH_TO, 'DD-MON-RR'))
AND SUBSTR(MSIB.SEGMENT1,1,2) IN ('RM', 'MP')
AND MSIB.INVENTORY_ITEM_ID=MIC.INVENTORY_ITEM_ID
AND MSIB.ORGANIZATION_ID=MIC.ORGANIZATION_ID
AND MIC.CATEGORY_ID=MCB.CATEGORY_ID
AND MCB.SEGMENT1 IN 
(
    'Bahan Baku Aktif',
    'Bahan Baku Penolong'
)
AND mtt1.TRANSACTION_TYPE_NAME NOT IN
(
-- Penerimaan
'PO Receipt', 'Return to Vendor','Direct Org Transfer'
)
GROUP BY MSIB.INVENTORY_ITEM_ID, MSIB.SEGMENT1, MSIB.DESCRIPTION, msib.PRIMARY_UOM_CODE, mtln1.LOT_NUMBER, MCB.SEGMENT1,msib.PRIMARY_UNIT_OF_MEASURE
)H1,
(
select max(rt1.TRANSACTION_DATE) TRANSACTION_DATE
,mtln1.INVENTORY_ITEM_ID
,mtln1.LOT_NUMBER
,rt1.CURRENCY_CONVERSION_RATE
,rt1.CURRENCY_CODE
,aps.VENDOR_NAME
,pha.SEGMENT1
,pla.UNIT_PRICE
,pla.UNIT_MEAS_LOOKUP_CODE
from mtl_material_transactions mmt1
,mtl_transaction_lot_numbers mtln1
,rcv_transactions rt1
,ap_suppliers aps
,po_headers_all pha
,po_lines_all pla
where 1=1
and rt1.PO_HEADER_ID = pha.PO_HEADER_ID
and pha.PO_HEADER_ID = pla.PO_HEADER_ID
and rt1.PO_LINE_ID = pla.PO_LINE_ID
and aps.VENDOR_ID = rt1.VENDOR_ID
and rt1.TRANSACTION_TYPE = 'DELIVER'
and mmt1.TRANSACTION_ID = mtln1.TRANSACTION_ID
and mmt1.RCV_TRANSACTION_ID = rt1.TRANSACTION_ID
group by mtln1.INVENTORY_ITEM_ID
,mtln1.LOT_NUMBER
,rt1.CURRENCY_CONVERSION_RATE
,rt1.CURRENCY_CODE
,aps.VENDOR_NAME
,pha.SEGMENT1
,pla.UNIT_PRICE
,pla.UNIT_MEAS_LOOKUP_CODE
)RT
,(
    SELECT DISTINCT MLN.INVENTORY_ITEM_ID, MLN.LOT_NUMBER, NVL(TO_CHAR(SIINAS.KODE), XIM.NEGARA) KODE
    FROM MTL_LOT_NUMBERS MLN
    ,IFS.XT_IFS_MANUFACTURER XIM
    ,IFS.XT_IFS_KODE_NEGARA_SIINAS  SIINAS
    WHERE MLN.C_ATTRIBUTE1=XIM.MANUFACTURER
    AND UPPER(XIM.NEGARA)=UPPER(SIINAS.NEGARA_MANUF(+))
)MLN
WHERE H1.INVENTORY_ITEM_ID=RT.INVENTORY_ITEM_ID
AND H1.LOT_NUMBER=RT.LOT_NUMBER
AND H1.INVENTORY_ITEM_ID=MLN.INVENTORY_ITEM_ID
AND H1.LOT_NUMBER=MLN.LOT_NUMBER
