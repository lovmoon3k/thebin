//—Å–∞–º–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–∏–º–µ—Ä–æ–º –∑–¥–µ—Å—å https://docs.google.com/spreadsheets/d/1Nx761zi5kCk2_u7ySIkzuGEKhSE3WUUi13Aqy4AEZoc/edit#gid=0
//—Å—é–¥–∞ –≤–≤–æ–¥–∏–º –Ω–∞—à API-–∫–ª—é—á, –ø–æ–ª—É—á–∞—Ç—å –∑–¥–µ—Å—å https://beta.openai.com/account/api-keys
const t = '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'

//—ç—Ç–∞ —á–∞—Å—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–∞ –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ–Ω—é –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞
function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('–°–∫—Ä–∏–ø—Ç—ã')
    .addItem('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å', 'go').addToUi()
};

//–≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
function go() {
  //–∞–¥—Ä–µ—Å API, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è
  const url = 'https://api.openai.com/v1/completions'

  //–Ω–æ –ø–µ—Ä–µ–¥ —ç—Ç–∏–º —Å–æ–±–µ—Ä—ë–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã: –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ –Ω–∞—à–µ–π —Ç–∞–±–ª–∏—Ü–µ –∏ –∫ –ª–∏—Å—Ç—É ü§ñ
  const ss = SpreadsheetApp.getActive();
  const sh = ss.getSheetByName('ü§ñ');

  //–∑–∞–±–µ—Ä—ë–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ A2:D2
  const args = sh.getRange("A2:D2").getValues()[0];

  //—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏–º —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —á–µ—Ç—ã—Ä–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–µ
  const [model, max_tokens, temperature, prompt] = args;

  //—Å–∞–º –∑–∞–ø—Ä–æ—Å, –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ —Ñ—É–Ω–∫—Ü–∏–∏ r (–º–æ–∂–µ—Ç–µ –µ—ë –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –¥—Ä—É–≥–∏–º API)
  //–≤ —Ñ—É–Ω–∫—Ü–∏—é –ø–µ—Ä–µ–¥–∞—ë–º —Å—Å—ã–ª–∫–∞ –Ω–∞ API, –º–µ—Ç–æ–¥ (get, post, put), API-–∫–ª—é—á –∏ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞
  //–≤ –Ω–∞—à–µ–º —Å–ª—É—á–∞–µ —Ç–µ–ª–æ —ç—Ç–æ –º–æ–¥–µ–ª—å, –≤–æ–ø—Ä–æ—Å, max_tokens, temperature
  const request = r(url, 'post', t, {
    "model": model,
    "prompt": prompt,
    "max_tokens": max_tokens,
    "temperature": temperature
  });

  //–∏–∑–≤–ª–µ–∫–∞–µ–º –ª–∏–±–æ –æ—Ç–≤–µ—Ç, –ª–∏–±–æ, –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–µ—Ç (–∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, —ç—Ç–æ –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–µ–ª–∏–∫–æ–º –∑–∞–ø—Ä–æ—Å
  const response = request.choices?.[0]?.text || request;

  //–≤—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –Ω–∞—à –ª–∏—Å—Ç —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ 3–π —Å—Ç—Ä–æ–∫–æ–π
  sh.insertRowBefore(3);

  //–∏ –≤—Å—Ç–∞–≤–ª—è–µ–º –≤ —ç—Ç—É —Å—Ç—Ä–æ—á–∫—É –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è, –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å–∞–º –æ—Ç–≤–µ—Ç
  sh.getRange(3, 7, 1, 3).setValues([[new Date(), args.join("|"), response]]);
}

function r(url, method, token, data) {
  let params = {
    method: method,
    muteHttpExceptions: true,
    contentType: 'application/json;',
    payload: JSON.stringify(data),
    'headers': {
      Authorization: 'Bearer ' + token
    }
  };

  var r = UrlFetchApp.fetch(url, params);
  r = JSON.parse(r)
  return r;
};