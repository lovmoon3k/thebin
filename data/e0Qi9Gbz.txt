// ==UserScript==
// @name        ğŸ’¡ pcbeta.com
// @namespace   pcbeta Scripts
// @version     0.6.0
// @author      ngbanyan
// @description è¿œæ™¯è®ºå›ç¾åŒ–
// @downloadURL https://pastebin.com/raw/VcMuuDAQ
// @updateURL   https://pastebin.com/raw/VcMuuDAQ
// @require     https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js
// @require     https://cdn.jsdelivr.net/npm/stickUp@2.3.1/src/stickUp.min.js
// @match       *://bbs.pcbeta.com/*
// @match       *://i.pcbeta.com/*
// @exclude     *://bbs.pcbeta.com/forum.php?mod=post*
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @run-at      document-idle
// ==/UserScript==

(function($, __css) {
	// é˜²æ­¢è·³å‡ºé˜²å¹¿å‘Šæç¤º
	//localStorage.setItem('adblock-detector-dialog', (Date.now() + 8640000).toString(36));
	// 520
	if ($('title').text().search(/520: Web server is returning an unknown error|504 Bad Gateway|æœåŠ¡å™¨ç»´æŠ¤ä¸­/) > -1) {
		//setTimeout(() => { location.href = location.href; }, 5000);
		return;
	}

	// æ£€æµ‹å½“å‰ç½‘å€
	const urlHas = (r) => location.href.search(r) > -1;
	let nextDiv;

	// è®¿é—®ä¸ªäººè®¾ç½®
	if (urlHas(/i\.pcbeta\.com/)) {
		nextDiv = $('#pt');
		if ($('#messagetext').length) nextDiv = $('#ct');
		let scbarAfter = nextDiv.nextAll().addBack().clone();
		let wwp = $('<div id="wwp" class="wp cl"></div>').append(scbarAfter);
		$('#wp').after(wwp).remove();
	}

	// è®¿é—®ä»»åŠ¡é¡µè‡ªåŠ¨æ‰“å¡
	if (urlHas(/i\.pcbeta\.com\/home\.php\?mod\=task$/)) {
		setTimeout(() => { $.get('https://i.pcbeta.com/home.php?mod=task&do=apply&id=149'); }, 1000);
		return;
	}

	// ä¸å¤„ç†ä»¥ä¸‹é¡µé¢
	if (!urlHas(/bbs\.pcbeta\.com/) ||
		urlHas(/mod=(?:post|mpdcp|attachment|logging|register|misc)/) ||
		urlHas(/(?:search)\.php/)
	) { return; }

	// å¹¿å‘Šè¿‡æ»¤æé†’
	const cssClean = {'height': '0', 'line-height': '0', 'padding': '0', 'margin': '0'};
	$('.ad, .a_pt, .a_pb').css(cssClean).remove();

	// æ ‡ç­¾é¡µ
	if (urlHas(/misc\.php/)) {
		$('.bm_c table tr:odd').css('background-color', 'var(--odd-bg)');
		return;
	}

	//$(function() {
		//setTimeout(function() {
			// å…¨éƒ¨åˆ é™¤
			//$('#wp > div:first').nextUntil('div#scbar').empty().css('height', '0').remove('iframe');
			nextDiv = $('#scbar');
			// é˜²æ­¢æç¤ºé¡µé¢å‡ºé”™
			if (urlHas(/viewthread/) && $('#messagetext').length > 0) nextDiv = $('#ct');
			let scbarAfter = nextDiv.nextAll().addBack().clone();
			let wwp = $('<div id="wwp" class="wp cl"></div>').append(scbarAfter);
			$('#wp').after(wwp).remove();
			// ä»…åˆ é™¤å¹¿å‘Šéƒ¨åˆ†ï¼Œæ³¨é‡Šä¸‹é¢ä¸¤è¡Œ
			//$('#wp > div:first').nextUntil('#scbar').not($('.pb_tan').css({'width': 'calc(var(--w)/3  - 30px)'}).parent().css({'width': 'var(--w)', 'height': '77px', 'border': '1px solid #ccc', 'background': '#fff'}));
		//}, 2200)
	//});

	// ç‰ˆå—ä¿¡æ¯æ¡
	$('h1.xs2').parent().parent().css({'padding': '0 0 0 20px', 'max-width': 'calc(var(--w) - 20px)', 'border-radius': '4px', 'border': '1px solid #ccc'});
	$('h1.xs2 span.xi2').css({'padding-right': '20px'});

	// åˆ—è¡¨å¶æ•°è¡ŒèƒŒæ™¯è‰²
	$('tbody[id^="normalthread"] tr:odd, tbody[id^="stickthread"] tr').css({'background-color': 'var(--odd-bg)'});

	// å›åˆ°é¡¶éƒ¨
	$('#scrolltop').css({'right': '10px'});

	// æµè§ˆé¡µ
	if (urlHas(/viewthread/)) {
		// å¹¿å‘Šå ä½
		$('.adsbygoogle, .google-auto-placed *, .google-auto-placed').css(cssClean).remove();
		// ä¸Šæ–¹æ·»åŠ ç¼–è¾‘æŒ‰é’®
		if ($('a.editp') && $('a#replynotice')) {
			$('a#replynotice').after($('a.editp').eq(0).clone()).after('<span class="pipe">|</span>');
		}
		// å±•å¼€å…¨æ–‡
		$('button.btn-explanate:visible').click();

		// å¸–å­å†…å®¹
		$('td[id^="postmessage"]').each(function() {
			// æå–æ ¡éªŒç ã€Key
			let _checksum = [];
			let _keys = [];
			$(this).text()
				.replace(/&nbsp;/g, ' ')
				.replace(/(?<=(?:MD5|SHA-?1|CRC32|SHA-?256)[ Â :ï¼š]*)\b([0-9a-zA-Z]{8}|[0-9a-zA-Z]{32}|[0-9a-zA-Z]{40}|[0-9a-zA-Z]{64})\b/g, function(m, m1) {
					_checksum.push(m1);
				})
				.replace(/\b(?:[0-9A-Z]{5}(?:\-[0-9A-Z]{5}){4})\b/g, function(m) {
					_keys.push(m);
				});
			// ä¿®å¤å¸–å­å†…å®¹
			let _html = $(this).html()
				// ä¿®å¤ Unicode æ˜¾ç¤º
				.replace(/(?:&|&amp;)#(\d+);?/g, function(m, m1) {
					return ~~m1 > 65535 ? String.fromCodePoint(m1) : String.fromCharCode(m1);
				})
				// æœ¬è®ºå›é“¾æ¥
				//.replace(/(?<=[^>"])https:\/\/bbs\.pcbeta\.com\/(?:forum\.php\?mod=viewthread&amp;tid=\d+(?:&amp;highlight=.+)?|viewthread\-\d+\-\d+\-\d+\.html)(?=[^<"])/g, function(m) {
				.replace(/https?:\/\/bbs\.pcbeta\.com\/(?:forum\.php\?mod=viewthread&amp;tid=\d+(?:&amp;highlight=.+)?|viewthread\-\d+\-\d+\-\d+\.html)(?=<\/(?:font|br)| |&nbsp;)/g, function(m) {
					return `<a href="${m}" target="_blank">${m}</a>`;
				})
				// data:image
				.replace(/img file="https?:\/\/data:image/g, function(m) {
					return `img src="data:image`;
				})
				// Music
				.replace(/\[music\](.+)\[\/music\]/g, function(m, m1) {
					return `<audio src="${m1}" controls />`;
				})
				// Video
				.replace(/\[video\](.+)\[\/video\]/g, function(m, m1) {
					return `<video src="${m1}" controls />`;
				});
			// ä¿®å¤æ ¡éªŒç 
			if (_checksum.length > 0) {
				_html = _html.replace(new RegExp(`\\b(?:${_checksum.join('|')})\\b`, 'g'), function(m) {
					return `<abbr title="ç‚¹å‡»å¤åˆ¶åˆ°å‰ªè´´æ¿" class="copy-clipboard" data-clipboard-text="${m}">${m}</abbr>`;
				})
			}
			// Key éšè—
			if (_keys.length > 0) {
				_html = _html.replace(new RegExp(`\\b(?:${_keys.join('|')})\\b`, 'g'), function(m) {
					return `<abbr title="ç‚¹å‡»å¤åˆ¶åˆ°å‰ªè´´æ¿" class="copy-clipboard key-hide" data-clipboard-text="${m}">${m}</abbr>`;
				})
			}
			$(this).html(_html);
		});
        // ç‚¹è¯„
        $('.psti').each(function() {
			let _html = $(this).html()
				// ä¿®å¤ Unicode æ˜¾ç¤º
				.replace(/(?:&|&amp;)#(\d+);?/g, function(m, m1) {
					return ~~m1 > 65535 ? String.fromCodePoint(m1) : String.fromCharCode(m1);
				})
			$(this).html(_html);
        })
		// å¤åˆ¶åˆ°å‰ªè´´æ¿
		let clipboard = new ClipboardJS('abbr.copy-clipboard');
		clipboard.on('success', function(e) {
			alert(e.text + ' å·²å¤åˆ¶!');
		});
		/** ç½‘é€Ÿè¾ƒå¿«æ—¶ï¼Œå¯ä½¿ç”¨è®ºå›è‡ªå¸¦å‡½æ•°
		$('abbr.copy-clipboard').click(function() {
			let _c = $(this).data('clipboard-text');
			setCopy(_c, _c + ' å¤åˆ¶æˆåŠŸ');
			return false;
		});
		**/
	}
	// é¡¶éƒ¨ç”¨æˆ·å¯¼èˆªæ‚¬åœ
	$("#toptb").stickUp();
	// ç¾åŒ–å¼€å§‹
	//GM_addStyle(__css);
	$('head').append(`<style id="diy_style">${__css}</style>`);
}(jQuery, `
:root {
  /* èƒŒæ™¯é˜´å½± */
  --shadow: 0 0 20px -5px rgba(51, 51, 51, .5);
  /* æ•´ä½“å®½åº¦ */
  --w: 1400px;
  /* åœ†è§’å®½åº¦ */
  --br: 4px;
  /* èƒŒæ™¯è‰² */
  --bg: #E1E2E8;
  /* åˆ†éš”æ èƒŒæ™¯è‰² */
  --sep-bg: #DAE7F6;
  /* å¶æ•°è¡ŒèƒŒæ™¯è‰² */
  --odd-bg: #f8f8f8;
}
/* å°å±å¹• */
@media screen and (max-width: 960px) {
  :root {
    --w: 900px;
  }
  .x_l > img, .x_m > img, .x_r > img { display: none; }
}
/* è·Ÿéšç³»ç»Ÿçš„ Dark æ¨¡å¼ */
@media (prefers-color-scheme: dark1) {
  :root {
    /* èƒŒæ™¯é˜´å½± */
    --shadow: 0 0 10px -5px #fff;
    /* åœ†è§’å®½åº¦ */
    --br: 4px;
    /* èƒŒæ™¯è‰² */
    --bg: #222529;
    /* åˆ†éš”æ èƒŒæ™¯è‰² */
    --sep-bg: #DAE7F6;
    /* å¶æ•°è¡ŒèƒŒæ™¯è‰² */
    --odd-bg: #f8f8f8;
  }
  #nv ul li a,
  #pt .z a {
    color: #fff;
  }
}
body {
  background: var(--bg);
  /*
  font-family: Microsoft YaHei UI Semibold;
  -webkit-text-stroke: 0.04px;
  */
  text-shadow: transparent 0px 0px 0px, rgba(0,0,0,0.68) 0px 0px 0px !important;
}
/* å­—ä½“ */
.common a.xst,
.new a.xst,
.lock a.xst {
  font-size: 1rem;
}
/* ä¸»ä½“åŠ å®½ */
#scbar,
.wp > div,
.wp {
  width: var(--w);
}
#scbar,
#thread_types li a,
#newspecial,
#newspecialtmp,
#fastpostsubmit,
#post_reply {
  border-radius: var(--br);
  box-shadow: var(--shadow);
}
h1.mt + .bm,
#ct .flg,
#skill-list,
#f_pst,
#postlist,
#threadlist {
  box-shadow: var(--shadow);
}
/* ç½®é¡¶å’Œå¸–å­åˆ—è¡¨åˆ†éš”åŒºæ ·å¼ */
#separatorline tr td,
#separatorline tr th {
  background-color: var(--sep-bg);
  line-height: 30px;
}
/* é¡¶éƒ¨ç”¨æˆ·å¿«æ·æ ·å¼ */
#um > div {
  box-shadow: var(--shadow);
  /* box-shadow: 0 1px 0.1em black inset; */
  border-radius:0 0 6px 6px;
  height: 35px;
  line-height: 33px;
}
#um {
  max-width: calc(var(--w) - 6px);
}
/* æœç´¢åŠ å®½åçš„èƒŒæ™¯å¡«å…… */
#scbar {
  background:url('https://www.pcbeta.com//static/image/pcbeta/search_df__.png') 0 -258px repeat-x;
}
/* æ¥¼å±‚åˆ†éš”çº¿ */
div#postlist table[id^="pid"] {
  border-bottom: 1px solid #85B2EF;
}
/* åˆ—è¡¨è¡Œé«˜ï¼Œå­—ä½“
tbody[id^="normalthread"] tr td,
tbody[id^="stickthread"] tr td {
  padding: 8px;
}
tbody[id^="normalthread"],
tbody[id^="stickthread"] {
  font-size: 16px;
}
*/
/* æµè§ˆé¡µæ‚¬åœä¿¡æ¯æ ·å¼ */
.tip { max-width: 200px; }
.p_pop { opacity: 0.85; }
/* æµè§ˆé¡µå¸–å­æ ‡é¢˜æ ·å¼ */
td.pbn > * {
  border-bottom: 1px solid #ECF1F7;
  padding-bottom: 10px;
  font-family: none; /* Microsoft Yahei */
}
h1.ts > a {
  font-weight: 500;
  font-size: 22px;
}
/* abbr æ ·å¼ */
abbr[title] {
  cursor: help;
  font-family: Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}
abbr[title].key-hide {
  color: #228B22;
  font-weight: 600;
  padding: 2px 2px;
}
/* video é™å®½ */
video {
  max-width: calc((var(--w)/2) + 200px);
}
.t_f {
  line-height: 1.8;
}
`));
